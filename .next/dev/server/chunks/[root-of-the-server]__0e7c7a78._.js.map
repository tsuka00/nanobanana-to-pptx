{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/abun/projects/web-apps/nanobanana-to-pptx/app/api/agent/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server'\nimport { spawn } from 'child_process'\nimport path from 'path'\n\ninterface AgentRequest {\n  prompt: string\n  imageBase64?: string\n  sessionId?: string\n  feedback?: string  // フィードバック継続用\n}\n\nexport async function POST(request: NextRequest) {\n  const body: AgentRequest = await request.json()\n  const { prompt, imageBase64, sessionId: existingSessionId, feedback } = body\n\n  if (!prompt && !feedback) {\n    return new Response(JSON.stringify({ error: 'Prompt or feedback is required' }), {\n      status: 400,\n      headers: { 'Content-Type': 'application/json' },\n    })\n  }\n\n  const projectRoot = path.resolve(process.cwd())\n\n  // ストリーミングレスポンスを設定\n  const encoder = new TextEncoder()\n  const stream = new ReadableStream({\n    async start(controller) {\n      try {\n        // Python agentをサブプロセスとして実行\n        const pythonScript = `\nimport sys\nimport os\nimport json\nimport base64\n\n# プロジェクトルートをパスに追加\nsys.path.insert(0, '${projectRoot}')\nos.chdir('${projectRoot}')\n\n# .env.localを読み込み\nfrom dotenv import load_dotenv\nload_dotenv('${projectRoot}/.env.local')\n\nfrom agents.react_agent import ReActDesignerAgent\n\n# 入力を受け取る\ninput_data = json.loads(sys.stdin.read())\n\nuser_prompt = input_data.get('prompt', '')\nimage_base64 = input_data.get('image_base64')\nsession_id = input_data.get('session_id')\n\n# エージェントを初期化\nagent = ReActDesignerAgent(\n    session_id=session_id,\n    enable_tracing=True\n)\n\n# セッション開始イベント\nprint(json.dumps({'type': 'session_start', 'sessionId': agent.session_id}), flush=True)\n\n# ツール実行をフックするためのモンキーパッチ\noriginal_execute_tool = agent._execute_tool\n\ndef hooked_execute_tool(action, action_input):\n    # ツール開始イベント\n    print(json.dumps({\n        'type': 'tool_start',\n        'tool': action,\n        'input': str(action_input)[:200]\n    }), flush=True)\n\n    result = original_execute_tool(action, action_input)\n\n    # ツール終了イベント\n    status = 'error' if result.startswith('Error:') else 'completed'\n    print(json.dumps({\n        'type': 'tool_end',\n        'tool': action,\n        'status': status,\n        'result': result[:300]\n    }), flush=True)\n\n    return result\n\nagent._execute_tool = hooked_execute_tool\n\n# Thoughtをキャプチャするためのフック\noriginal_parse = agent._parse_action\n\ndef hooked_parse(response_text):\n    parsed = original_parse(response_text)\n    if parsed.get('thought'):\n        print(json.dumps({\n            'type': 'thought',\n            'content': parsed['thought'][:500]\n        }), flush=True)\n    return parsed\n\nagent._parse_action = hooked_parse\n\n# フィードバックツールをオーバーライド（Web UIではフィードバック待ちイベントを送信）\ndef web_ask_feedback(params):\n    question = params.get('question', '生成結果を確認してください。修正点はありますか？')\n\n    # フィードバック待ちイベントを送信\n    print(json.dumps({\n        'type': 'waiting_feedback',\n        'question': question,\n        'pptxPath': agent._result.get('pptx_path') if agent._result else None,\n        'backgroundPath': agent._result.get('background_path') if agent._result else None\n    }), flush=True)\n\n    # Web UIでは自動的にOKで継続（後でフィードバック機能を追加可能）\n    return \"ユーザーのフィードバック: OK\"\n\nagent._tool_ask_feedback = web_ask_feedback\n\n# 実行\nresult = agent.run(\n    user_prompt=user_prompt,\n    reference_image_base64=image_base64,\n    max_iterations=10\n)\n\n# イテレーション情報\nprint(json.dumps({\n    'type': 'iterations',\n    'count': result.get('iterations', 0),\n    'tools': [t['action'] for t in result.get('tools_executed', [])]\n}), flush=True)\n\n# 結果を出力\nif result.get('success'):\n    print(json.dumps({\n        'type': 'message',\n        'content': result.get('final_answer', 'スライドの生成が完了しました。')\n    }), flush=True)\n\n    if result.get('result') and result['result'].get('pptx_path'):\n        print(json.dumps({\n            'type': 'pptx_generated',\n            'pptxPath': result['result']['pptx_path'],\n            'previewPath': result['result'].get('background_path'),\n            'sessionId': agent.session_id\n        }), flush=True)\nelse:\n    print(json.dumps({\n        'type': 'error',\n        'content': f\"エラーが発生しました: {result.get('error', 'Unknown error')}\"\n    }), flush=True)\n\n# トレーシングサマリー\nif result.get('tracing_summary'):\n    summary = result['tracing_summary']\n    print(json.dumps({\n        'type': 'tracing_summary',\n        'totalTokens': summary.get('total_tokens', 0),\n        'inputTokens': summary.get('input_tokens', 0),\n        'outputTokens': summary.get('output_tokens', 0),\n        'totalCost': summary.get('total_cost', 0)\n    }), flush=True)\n\nprint(json.dumps({'type': 'done', 'sessionId': agent.session_id, 'success': result.get('success', False)}), flush=True)\n`\n\n        const inputData = {\n          prompt,\n          image_base64: imageBase64?.replace(/^data:image\\/[^;]+;base64,/, ''),\n          session_id: existingSessionId,\n          feedback,\n        }\n\n        const pythonProcess = spawn('python3', ['-c', pythonScript], {\n          cwd: projectRoot,\n          env: { ...process.env },\n        })\n\n        // 入力データを送信\n        pythonProcess.stdin.write(JSON.stringify(inputData))\n        pythonProcess.stdin.end()\n\n        // 出力を処理\n        let buffer = ''\n\n        pythonProcess.stdout.on('data', (data: Buffer) => {\n          buffer += data.toString()\n          const lines = buffer.split('\\n')\n          buffer = lines.pop() || ''\n\n          for (const line of lines) {\n            if (!line.trim()) continue\n\n            // JSONイベントのみを送信\n            if (line.startsWith('{')) {\n              try {\n                JSON.parse(line) // 有効なJSONかチェック\n                controller.enqueue(encoder.encode(line + '\\n'))\n              } catch {\n                // JSONでない場合はスキップ\n              }\n            }\n          }\n        })\n\n        pythonProcess.stderr.on('data', (data: Buffer) => {\n          const stderr = data.toString()\n          // Warningは無視、Errorのみログ\n          if (stderr.includes('Error') && !stderr.includes('Warning')) {\n            console.error('Python stderr:', stderr)\n          }\n        })\n\n        await new Promise<void>((resolve, reject) => {\n          pythonProcess.on('close', (code) => {\n            // 残りのバッファを処理\n            if (buffer.trim() && buffer.startsWith('{')) {\n              try {\n                JSON.parse(buffer)\n                controller.enqueue(encoder.encode(buffer + '\\n'))\n              } catch {\n                // ignore\n              }\n            }\n\n            if (code !== 0 && code !== null) {\n              controller.enqueue(\n                encoder.encode(\n                  JSON.stringify({\n                    type: 'error',\n                    content: `プロセスがエラーコード ${code} で終了しました。`,\n                  }) + '\\n'\n                )\n              )\n            }\n            resolve()\n          })\n\n          pythonProcess.on('error', (err) => {\n            reject(err)\n          })\n        })\n\n      } catch (error) {\n        controller.enqueue(\n          encoder.encode(\n            JSON.stringify({\n              type: 'error',\n              content: `エラーが発生しました: ${error instanceof Error ? error.message : 'Unknown error'}`,\n            }) + '\\n'\n          )\n        )\n      } finally {\n        controller.close()\n      }\n    },\n  })\n\n  return new Response(stream, {\n    headers: {\n      'Content-Type': 'text/plain; charset=utf-8',\n      'Transfer-Encoding': 'chunked',\n      'Cache-Control': 'no-cache',\n    },\n  })\n}\n"],"names":[],"mappings":"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"}}]
}