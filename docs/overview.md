# システム概要

## アーキテクチャ

Nanobanana to PPTX は、Nanobanana（Gemini 3 Pro Image）で生成した高品質画像を分析し、編集可能なPPTXに変換するAIエージェントシステムです。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Designer Agent                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐   ┌────────────────────┐   ┌─────────────────────┐       │
│  │ ユーザー入力  │──▶│ Phase 0: Nanobanana │──▶│ Phase 0.5: Web研究  │       │
│  │ (自然言語)    │   │ (画像生成)          │   │ (オプション)        │       │
│  └──────────────┘   └────────────────────┘   └──────────┬──────────┘       │
│                                                          │                  │
│                      ┌───────────────────────────────────┘                  │
│                      ▼                                                       │
│             ┌─────────────────┐   ┌─────────────────┐                       │
│             │ Phase 1a: 分析  │──▶│ Phase 1b: 設計  │                       │
│             │ (Reasoning)     │   │ (JSON生成)      │                       │
│             └─────────────────┘   └────────┬────────┘                       │
│                                            │                                │
│                                            ▼                                │
│                      ┌─────────────────────────────────────┐               │
│                      │ Phase 2: 実行                       │               │
│                      │ ┌─────────────────────────────────┐ │               │
│                      │ │ Step 1: 画像分析（Gemini 3 Pro） │ │               │
│                      │ │ - テキスト要素 → SVG生成         │ │               │
│                      │ │ - 非テキスト要素 → bbox取得      │ │               │
│                      │ └─────────────────────────────────┘ │               │
│                      │ ┌─────────────────────────────────┐ │               │
│                      │ │ Step 2: PPTX生成                 │ │               │
│                      │ │ - 背景/イラスト → 元画像切り出し │ │               │
│                      │ │ - テキスト → SVG→PNG変換         │ │               │
│                      │ │ - スライドに配置                 │ │               │
│                      │ └─────────────────────────────────┘ │               │
│                      └─────────────────────────────────────┘               │
│                                            │                                │
│                                            ▼                                │
│                               ┌─────────────────────┐                      │
│                               │ agent_output/       │                      │
│                               │ └── {session_id}/   │                      │
│                               │     ├── *.pptx      │                      │
│                               │     ├── *.png       │                      │
│                               │     └── *.svg       │                      │
│                               └─────────────────────┘                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 処理フロー

### Phase 0: Nanobanana前処理

ユーザーの指示からNanobanana（Gemini 3 Pro Image）で高品質画像を生成します。

```
入力: ユーザープロンプト + 参照画像（オプション）
出力: 高品質画像（agent_output/{session_id}/nanobanana.png）
```

**使用モデル**: `gemini-3-pro-image`（text_to_image.py）

### Phase 0.5: Web Research（オプション）

デザインに関連する情報をWeb検索で収集します（エージェントが自律判断）。

### Phase 1a: デザイン分析（Reasoning）

ユーザーのプロンプトを深く分析し、最適なデザイン方針を決定します。

**分析項目:**
- 意図の理解（何を伝えたいか）
- ターゲット（誰に向けたデザインか）
- 雰囲気・トーン
- レイアウトの検討
- 配色パレットの選定

### Phase 1b: 設計フェーズ

Reasoning結果を元に、構造化された設計JSONを生成します。

### Phase 2: 実行フェーズ

**Step 1: 画像分析（analyze_image）**

Gemini 3 Pro でNanobanana画像を分析し、要素を識別します。

```
入力: nanobanana.png
出力:
  - テキスト要素: bbox + SVG（テキストスタイルを再現）
  - 非テキスト要素: bbox のみ（背景、イラスト、写真など）
```

**Step 2: PPTX生成（image_to_pptx）**

識別された要素をPPTXに配置します。

```
処理:
  - テキスト要素: SVG → PNG変換（cairosvg）→ スライドに配置
  - 非テキスト要素: 元画像から切り出し → スライドに配置
  - 背景: 元画像全体を背景として配置

出力: {session_id}.pptx
```

## 要素の処理方法

| 要素タイプ | 処理方法 | PPTX配置 |
|-----------|---------|----------|
| background | 元画像から切り出し | 全画面背景画像 |
| text | SVG生成 → PNG変換 | bbox位置に画像配置 |
| illustration | 元画像から切り出し | bbox位置に画像配置 |
| image | 元画像から切り出し | bbox位置に画像配置 |

### テキスト要素のSVG生成

Gemini 3 Pro が画像内のテキストを分析し、見た目を再現するSVGを生成します。

```xml
<!-- 例: グラデーションテキスト -->
<svg viewBox="0 0 780 160" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="goldGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#FFF5C3" />
      <stop offset="50%" stop-color="#EBCFA0" />
      <stop offset="100%" stop-color="#C59D5F" />
    </linearGradient>
  </defs>
  <text x="390" y="140"
        font-family="'Noto Sans CJK JP', sans-serif"
        font-weight="900"
        font-size="150"
        fill="url(#goldGradient)"
        text-anchor="middle">1,000,000</text>
</svg>
```

**注意**: 複雑なテキストスタイル（3D、影、縁取りなど）の完全な再現には限界があります。

## 出力ファイル構成

```
agent_output/
└── {session_id}/
    ├── nanobanana.png      # Nanobanana前処理画像
    ├── result.png          # 結果画像
    ├── design.json         # 設計JSON
    ├── {session_id}.pptx   # 最終PPTX
    │
    │  # 要素ファイル（analyze_imageで識別された各要素）
    ├── background.png      # 背景（元画像から切り出し）
    ├── text_1.svg          # テキストSVG
    ├── text_1.png          # テキストPNG（SVG変換後）
    ├── text_2.svg          # テキストSVG
    ├── text_2.png          # テキストPNG（SVG変換後）
    ├── illustration_1.png  # イラスト（元画像から切り出し）
    └── ...
```

セッションIDは `XXXX-YYYY` 形式（例: `SYV4-1867`）で自動生成されます。

## キャンバス仕様

- **サイズ**: 1920 x 1080 ピクセル（16:9）
- **座標系**: 左上が (0, 0)、右下が (1920, 1080)

## 使用モデル

| 用途 | モデル |
|------|--------|
| 前処理画像生成 | gemini-3-pro-image（Nanobanana） |
| 画像分析・SVG生成 | gemini-3-pro-preview |
| 設計解析・Reasoning | gemini-3-pro-preview |

## プリセットシステム

Designer Agent はプリセットシステムを使用して一貫性のあるデザインを生成します。

### レイアウトプリセット

| 値 | タイトル位置 | 説明 |
|----|-------------|------|
| center | (960, 400) | 中央配置（デフォルト） |
| left | (200, 400) | 左寄せ |
| right | (1720, 400) | 右寄せ |
| bottom | (960, 800) | 下部配置 |
| ... | | |

### 配色パレット

| 値 | 背景色 | 用途 |
|----|--------|------|
| light | #ffffff | 明るい、ビジネス |
| dark | #1a1a1a | モダン |
| dark-tech | #0a0a0a | テック、サイバー |
| ... | | |

詳細は [JSONスキーマ](json-schema.md) を参照してください。

## エラーハンドリング

各ツールはエラー時に以下の形式でレスポンスを返します：

```json
{
  "success": false,
  "error": "エラーメッセージ"
}
```

エージェントはエラーが発生しても処理を継続し、生成可能な要素のみでPPTXを生成します。
