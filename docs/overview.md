# システム概要

## アーキテクチャ

Nanobanana Designer Agent は、自然言語の指示から画像デザインを生成する多フェーズ構成のAIエージェントシステムです。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Designer Agent                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐   ┌────────────────┐   ┌─────────────────┐                │
│  │ ユーザー入力  │──▶│ Phase 0: 前処理 │──▶│ Phase 1a: 分析  │                │
│  │ (自然言語)    │   │ (Nanobanana)   │   │ (Reasoning)     │                │
│  └──────────────┘   └────────────────┘   └────────┬────────┘                │
│                                                    │                         │
│                                                    ▼                         │
│                      ┌────────────────┐   ┌─────────────────┐               │
│                      │ Phase 1b: 設計 │◀──┤ 設計JSON生成    │               │
│                      │ (Gemini 2.0)   │   │                 │               │
│                      └───────┬────────┘   └─────────────────┘               │
│                              │                                               │
│                              ▼                                               │
│                      ┌─────────────────────────────────────┐                │
│                      │ Phase 2: 実行（各ツール呼び出し）    │                │
│                      └───────┬─────────────────────────────┘                │
│                              │                                               │
│              ┌───────────────┼───────────────┐                              │
│              ▼               ▼               ▼                              │
│        ┌──────────┐   ┌──────────┐   ┌──────────┐                          │
│        │ PNG出力  │   │ SVG出力  │   │ PPTX出力 │                          │
│        └──────────┘   └──────────┘   └──────────┘                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 処理フロー

### Phase 0: Nanobanana前処理

ユーザーの指示からスタイル参照用の画像を生成します（オプション）。

```
入力: ユーザープロンプト + 参照画像（オプション）
出力: スタイル参照画像（output_parse_image/{session_id}.png）
```

### Phase 1a: デザイン分析（Reasoning）

ユーザーのプロンプトを深く分析し、最適なデザイン方針を決定します。

**分析項目:**
- 意図の理解（何を伝えたいか）
- ターゲット（誰に向けたデザインか）
- 雰囲気・トーン
- レイアウトの検討
- テキストスタイルの選定

### Phase 1b: 設計フェーズ

Reasoning結果を元に、Gemini 2.0 Flash で構造化された設計JSONを生成します。

**入力例:**
```
背景は青空、左下に緑色の三角形シェイプを配置、
タイトルは「Hello World」を中央上部に白文字で表示
```

**出力例（設計JSON）:**
```json
{
  "background": {
    "prompt": "青空、晴れた日の空、雲が浮かぶ"
  },
  "illustration": {
    "type": "polygon",
    "points": [[0, 400], [0, 1080], [600, 1080]],
    "fill": {
      "type": "solid",
      "color": "#4CAF50"
    },
    "opacity": 1.0
  },
  "title": {
    "text": "Hello World",
    "x": 960,
    "y": 400,
    "fontSize": 64,
    "style": "flat",
    "color": "#ffffff"
  },
  "subtitle": null
}
```

### Phase 2: 実行フェーズ

設計JSONに基づいて各要素を順番に生成し、最終的に合成します。

```
Step 1: 背景生成
   │
   ├── text-to-image モード: text_to_background ツール
   │   └── Gemini 2.5 Flash Image で背景画像を生成
   │
   └── image-to-image モード: image_to_background ツール
       └── 参考画像のスタイルを参照して新規背景を生成
   │
   ▼
Step 2: イラスト生成
   │
   ├── PNG版: draw_illustration（Pillow）
   └── SVG版: draw_illustration_svg（ネイティブSVG）
   │
   ▼
Step 3: タイトル生成
   │
   ├── PNG版: text_to_title（Pillow）
   └── SVG版: text_to_title_svg（スタイルプリセット対応）
   │
   ▼
Step 4: サブタイトル生成
   │
   ├── PNG版: text_to_subtitle（Pillow）
   └── SVG版: text_to_subtitle_svg（スタイルプリセット対応）
   │
   ▼
Step 5: PNG合成
   │
   └── compose_slide ツール
       └── 全要素を重ね合わせて最終PNG画像を生成
   │
   ▼
Step 6: SVG合成
   │
   └── compose_slide_svg ツール
       └── 全SVG要素を合成して編集可能なSVGを生成
       └── Adobe Illustrator で各レイヤーを個別編集可能
   │
   ▼
Step 7: PPTX生成
   │
   └── svg_to_pptx_editable ツール
       └── 背景・イラスト: 画像レイヤーとして配置
       └── タイトル・サブタイトル: ネイティブテキストボックス（編集可能）
```

## 出力形式の比較

| 形式 | 背景 | イラスト | タイトル | サブタイトル | 用途 |
|------|------|----------|----------|--------------|------|
| PNG | ラスター | ラスター | ラスター | ラスター | プレビュー |
| SVG | ラスター埋め込み | ベクター | ベクター | ベクター | Illustrator編集 |
| PPTX | 画像 | 画像 | テキストボックス | テキストボックス | PowerPoint編集 |

### SVG生成の詳細

| 要素 | PNG生成 | SVG生成 | 編集 |
|------|---------|---------|------|
| 背景 | Gemini生成画像 | ラスター埋め込み | 再生成で対応 |
| イラスト | draw_illustration（Pillow） | ネイティブSVG | 編集可能 |
| タイトル | text_to_title（Pillow） | SVGテキスト + スタイル | 編集可能 |
| サブタイトル | text_to_subtitle（Pillow） | SVGテキスト + スタイル | 編集可能 |

### PPTX出力の詳細

| 要素 | 配置方法 | 編集 |
|------|----------|------|
| 背景 | 画像（フル画面） | 移動・リサイズ可 |
| イラスト | 画像（透過PNG） | 移動・リサイズ可 |
| タイトル | テキストボックス | **テキスト編集可能** |
| サブタイトル | テキストボックス | **テキスト編集可能** |

## テキストスタイルプリセット

SVG出力時に適用可能な10種類のスタイル：

| スタイル | 説明 | 特徴 |
|----------|------|------|
| `flat` | シンプルな単色 | 軽量、高速 |
| `shadow` | ドロップシャドウ | 可読性向上 |
| `3d-metallic` | 3D/メタリック/ホログラム | 立体感、光沢、虹色反射 |
| `neon-glow` | ネオン発光 | 複数レイヤーのグロー効果 |
| `glass` | ガラス風透明感 | 透明感、反射 |
| `outline` | アウトライン | ストロークのみ |
| `gold` | ゴールドメタリック | 金色グラデーション |
| `silver` | シルバーメタリック | 銀色グラデーション |
| `emboss` | エンボス/浮き彫り | 立体的な浮き出し |
| `gradient` | 2色グラデーション | シンプルな色変化 |

## キャンバス仕様

- **サイズ**: 1920 x 1080 ピクセル（16:9）
- **座標系**: 左上が (0, 0)、右下が (1920, 1080)
- **テキスト座標**: 中心基準で指定

### 座標の目安

| 位置 | X座標 | Y座標 |
|------|-------|-------|
| 中央 | 960 | 540 |
| 左上 | 200 | 200 |
| 右上 | 1720 | 200 |
| 左下 | 200 | 880 |
| 右下 | 1720 | 880 |
| タイトル位置 | 960 | 400 |
| サブタイトル位置 | 960 | 500 |

## 動作モード

### text-to-image モード

プロンプトのみで新規画像を生成します。

```python
agent = DesignerAgent()
result = agent.generate("青空の背景にタイトル「Hello」")
```

### image-to-image モード

参考画像を元に新規画像を生成します。参考画像のスタイル、構図、雰囲気を参照しつつ、新しい画像を生成します。

```python
agent = DesignerAgent()
result = agent.generate(
    "この画像のスタイルで新しいデザインを作成",
    image_base64=reference_image_base64
)
```

**重要**: image-to-image モードでは、参考画像をそのまま編集するのではなく、参考画像のスタイルを参照して新規に生成します。

## 出力ファイル構成

```
output/                     # PNG画像
├── background/             # 背景画像
│   └── SESSION_ID.png
├── illustration/           # イラスト（透過PNG）
│   └── SESSION_ID.png
├── title/                  # タイトル（透過PNG）
│   └── SESSION_ID.png
├── subtitle/               # サブタイトル（透過PNG）
│   └── SESSION_ID.png
└── result/                 # 最終合成画像
    └── SESSION_ID.png

output_svg/                 # SVGファイル
├── background/             # 背景SVG（ラスター埋め込み）
│   └── SESSION_ID.svg
├── illustration/           # イラストSVG
│   └── SESSION_ID.svg
├── title/                  # タイトルSVG（スタイルプリセット適用）
│   └── SESSION_ID.svg
├── subtitle/               # サブタイトルSVG（スタイルプリセット適用）
│   └── SESSION_ID.svg
└── result/                 # 最終合成SVG
    └── SESSION_ID.svg

output_pptx/                # PowerPointファイル
└── result/                 # PPTX（テキスト編集可能）
    └── SESSION_ID.pptx

output_design/              # 設計JSON
└── SESSION_ID.json

output_parse_image/         # Nanobanana前処理画像
└── SESSION_ID.png
```

セッションIDは `XXXX-YYYY` 形式（例: `SYV4-1867`）で自動生成されます。

## 使用モデル

| 用途 | モデル |
|------|--------|
| 設計解析 | gemini-2.0-flash |
| 背景画像生成 | gemini-2.5-flash-image |
| 前処理画像生成 | Nanobanana |

## エラーハンドリング

各ツールはエラー時に以下の形式でレスポンスを返します：

```json
{
  "success": false,
  "error": "エラーメッセージ"
}
```

エージェントはエラーが発生しても処理を継続し、生成可能な要素のみで合成を試みます。
